#!/usr/bin/env bash

muttfile=~/.muttrc

function washmutt() {
        set -o xtrace
        for field in 'smtp_url' 'folder' 'realname' 'from' 'spoolfile'; do
                sed -i "/${field}/d" ${muttfile}
        done
}

function protonmutt() {
        set -eo xtrace 
        if ! [ $# -eq 4 ]; then
                {
                        echo "USAGE: proton <USER> <PASS> <NAME> <MAIL>"
                        exit 1
                }
        fi

        bridge_out=$(echo ${2} | hydroxide auth ${1})
        bridge_pass=$(echo $bridge_out | awk 'NF>1{print $NF}')

        washmutt

        echo "set folder=\"imap://${1}:${bridge_pass}@127.0.0.1:1143\"" >>${muttfile}
        echo "set smtp_url=\"smtp://${1}:${bridge_pass}@127.0.0.1:1025\"" >>${muttfile}
        echo "set spoolfile=\"+INBOX\"" >>${muttfile}
        echo "set realname=${3}" >>${muttfile}
        echo "set from=${4}" >>${muttfile}

        hydroxide smtp &
        hydroxide imap &

        echo "SUCCESS. Ready for mutt login."
        read

        mutt -F ${muttfile}
}
